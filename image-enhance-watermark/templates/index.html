<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图像增强与水印系统（课程设计通用版）</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", sans-serif; }
        body { background: #f8f9fa; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .header h1 { color: #2d7ff9; font-size: 24px; }
        .tab { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 25px; }
        .tab-btn { padding: 10px 25px; border: none; background: none; cursor: pointer; font-size: 16px; }
        .tab-btn.active { color: #2d7ff9; border-bottom: 2px solid #2d7ff9; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .card-title { font-size: 18px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: #666; font-weight: 500; }
        .form-control { width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .upload-area { border: 1px dashed #ddd; padding: 40px 20px; text-align: center; cursor: pointer; margin-bottom: 15px; transition: all 0.3s; }
        .upload-area:hover { border-color: #2d7ff9; background: #f5f9ff; }
        .btn { background: #2d7ff9; color: #fff; border: none; padding: 10px 30px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
        .btn:hover { background: #1a69e0; }
        .result-row { display: flex; gap: 30px; flex-wrap: wrap; margin-top: 20px; }
        .result-item { flex: 1; min-width: 300px; }
        .img-box { height: 220px; background: #fafafa; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #eee; }
        .img-box img { max-width: 100%; max-height: 100%; }
        .metrics-row { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
        .metric-item { flex: 1; min-width: 180px; border: 1px solid #eee; padding: 15px; border-radius: 4px; text-align: center; }
        .metric-label { color: #666; font-size: 14px; margin-bottom: 8px; }
        .metric-value { color: #2d7ff9; font-size: 16px; font-weight: bold; }
        .preview-img { max-width: 100%; margin-top: 10px; border: 1px solid #eee; border-radius: 4px; }
        .loading { display: none; margin-left: 10px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>基于直方图均衡化与DWT的图像版权保护系统</h1>
            <p>课程设计 | 支持任意ASCII水印嵌入与提取 | 算法简化版</p>
        </div>

        <!-- 标签页（简化，仅2个功能） -->
        <div class="tab">
            <button class="tab-btn active" onclick="switchTab('embed')">嵌入水印</button>
            <button class="tab-btn" onclick="switchTab('extract')">提取水印</button>
        </div>

        <!-- 嵌入模块（通用版，支持自定义水印） -->
        <div class="tab-content active" id="embed">
            <div class="card">
                <div class="card-title">嵌入操作</div>
                <form id="embed-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="form-label">1. 上传原始图像（支持JPG/PNG，≥150×150像素）</label>
                        <label class="upload-area" for="embed-img">
                            <input type="file" id="embed-img" name="image" accept="image/jpg,image/jpeg,image/png" class="hidden" onchange="previewImage(this, 'embed-preview')">
                            点击上传图像
                        </label>
                        <div id="embed-preview"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">2. 输入水印文本（仅支持ASCII字符，如字母、数字、符号）</label>
                        <input type="text" name="watermark" class="form-control" value="test123456" placeholder="请输入水印文本">
                    </div>
                    <button type="submit" class="btn">开始处理（增强+嵌入水印）</button>
                    <span class="loading" id="embed-loading">处理中...</span>
                </form>
            </div>

            <div class="card">
                <div class="card-title">处理结果</div>
                <div class="result-row">
                    <div class="result-item">
                        <h3 style="font-size: 16px; margin-bottom: 10px;">原始图像</h3>
                        <div class="img-box" id="original-img">未上传</div>
                    </div>
                    <div class="result-item">
                        <h3 style="font-size: 16px; margin-bottom: 10px;">结果图像（PNG无损格式）</h3>
                        <div class="img-box" id="final-img">未生成</div>
                    </div>
                </div>
                <div class="metrics-row">
                    <div class="metric-item">
                        <div class="metric-label">嵌入的水印</div>
                        <div class="metric-value" id="input-watermark">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">提取的水印</div>
                        <div class="metric-value" id="extracted-watermark">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">PSNR（dB）</div>
                        <div class="metric-value" id="psnr">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">SSIM</div>
                        <div class="metric-value" id="ssim">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 提取模块（通用版，输入长度） -->
        <div class="tab-content" id="extract">
            <div class="card">
                <div class="card-title">提取操作</div>
                <form id="extract-form">
                    <div class="form-group">
                        <label class="form-label">1. 上传结果图像（仅支持系统生成的PNG文件）</label>
                        <label class="upload-area" for="extract-img">
                            <input type="file" id="extract-img" name="watermarked_image" accept="image/png" class="hidden" onchange="previewImage(this, 'extract-preview')">
                            点击上传PNG图像
                        </label>
                        <div id="extract-preview"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">2. 输入水印长度（嵌入时的字符个数）</label>
                        <input type="number" name="watermark_length" class="form-control" value="8" min="1" placeholder="请输入水印长度">
                    </div>
                    <button type="button" class="btn" onclick="doExtract()">提取水印</button>
                    <span class="loading" id="extract-loading">提取中...</span>
                </form>
            </div>

            <div class="card">
                <div class="card-title">提取结果</div>
                <div class="metric-item" style="max-width: 400px; margin: 0 auto;">
                    <div class="metric-label">提取到的水印文本</div>
                    <div class="metric-value" id="extract-result">未提取</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 简化标签页切换
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // 简化图像预览
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    preview.innerHTML = `<img src="${e.target.result}" class="preview-img">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 嵌入表单提交（简化，无复杂逻辑）
        document.getElementById('embed-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const btn = this.querySelector('button');
            const loading = document.getElementById('embed-loading');
            btn.disabled = true;
            loading.style.display = 'inline';

            fetch('/', { method: 'POST', body: formData })
                .then(res => res.text())
                .then(html => {
                    document.open();
                    document.write(html);
                    document.close();
                })
                .catch(err => {
                    btn.disabled = false;
                    loading.style.display = 'none';
                    alert('处理失败，请重试');
                });
        });

        // 提取操作（简化，直接调用接口）
        function doExtract() {
            const fileInput = document.getElementById('extract-img');
            const lenInput = document.getElementById('extract-form').querySelector('input[name="watermark_length"]');
            const loading = document.getElementById('extract-loading');
            const result = document.getElementById('extract-result');

            if (!fileInput.files || !fileInput.files[0]) {
                alert('请上传PNG结果图');
                return;
            }
            if (!lenInput.value || lenInput.value < 1) {
                alert('请输入有效的水印长度');
                return;
            }

            const formData = new FormData();
            formData.append('watermarked_image', fileInput.files[0]);
            formData.append('watermark_length', lenInput.value);

            loading.style.display = 'inline';
            result.textContent = '提取中...';

            fetch('/extract', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    loading.style.display = 'none';
                    if (data.status === 'success') {
                        result.textContent = data.extracted_watermark;
                    } else {
                        alert('提取失败：' + data.msg);
                        result.textContent = '提取失败';
                    }
                })
                .catch(err => {
                    loading.style.display = 'none';
                    result.textContent = '提取失败';
                });
        }

        // 页面加载填充结果（简化，直接渲染）
        document.addEventListener('DOMContentLoaded', function() {
            const originalImg = '{{ original_img if original_img else "" }}';
            if (originalImg) {
                // 填充原图
                document.getElementById('original-img').innerHTML = `<img src="{{ url_for('uploaded_file', filename=original_img) }}">`;
                // 填充结果图
                const finalImg = '{{ final_img if final_img else "" }}';
                document.getElementById('final-img').innerHTML = `<img src="{{ url_for('processed_file', filename=final_img) }}">`;
                // 填充数据
                document.getElementById('input-watermark').textContent = '{{ watermark_text if watermark_text else "" }}';
                document.getElementById('extracted-watermark').textContent = '{{ extracted_wm if extracted_wm else "" }}';
                document.getElementById('psnr').textContent = '{{ psnr if psnr else "" }}';
                document.getElementById('ssim').textContent = '{{ ssim if ssim else "" }}';
            }
        });
    </script>
</body>
</html>